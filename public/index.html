<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webchat Project</title>
  </head>

  <body>

    <div>
        <h3>Welcome to Web Chat</h3>
    </div>

    <div>
      <ul id="usersList"></ul>
    </div>

    <form id="formNickname" action="">
      <label for="nickname">Nickname:</label>
      <input type="text" id="nicknameInput" placeholder="nickname" data-testid="nickname-box"> 
      <button type="button" id="nicknameButton" data-testid="nickname-button">Save </button><br><br>
    </form>

    <form id="formMessages" action="">
      <label for="labelname">Message:</label>
      <input type="text" id="messageInput" placeholder="message" data-testid="message-box">
      <button type="button" id="sendButton" data-testid="send-button">Enviar</button> 
     </form>

    <ul id="messages"></ul>

  </body>
  
  <script src="/socket.io/socket.io.js"></script>

  <script>
    const socket = io();

    //seletor lista de usuario
    const usersList = document.querySelector('#usersList');

    //seletores relacionados ao nickname
    const formNickname = document.querySelector('#formNickname');
    const nicknameInput = document.querySelector('#nicknameInput');
    const buttonSaveNick = document.querySelector('#nicknameButton');

    // seletores relacionados as mensagens
    const formMessages = document.querySelector('#formMessages');
    const messageInput = document.querySelector('#messageInput');
    const buttonSendMsg = document.querySelector('#sendButton');
    
    //seletor relacionado a lista de mensagem
    const listMsg = document.querySelector('#messages');
   
    // função para gerar nome aleatório com 16 caracteres
    function generatingRandomName() {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let generatedName = '';
      for (let i = 0; i < 16; i += 1) {
       generatedName += characters.charAt(Math.floor(Math.random() * characters.length));
      }
      return generatedName;
    }

    // recupera o nome aleatorio do sessionStorage e permite a alteração, emitindo evento aos demais usuários através do socket para exibição do novo nome 
    const setRandomName = generatingRandomName()
    sessionStorage.setItem('username', setRandomName);

    socket.emit('updateNickname', setRandomName);

    formNickname.addEventListener('click', (event) => {
      event.preventDefault();
      if (nicknameInput.value) {
        sessionStorage.setItem('username', nicknameInput.value);
        socket.emit('updateNickname', nicknameInput.value)
        nicknameInput.value = ''
      }
    })

    // atrela ao botao de enviar mensagem a captura do nome de quem enviou e o conteudo da mensagem, criando uma constante com o objeto de resposta e enviando aos demais usuarios pelo emit
    buttonSendMsg.addEventListener('click', (event) => {
      event.preventDefault();
      console.log('message send');
      const nickname = sessionStorage.getItem('username');
      const message = messageInput.value;
      const data = {
        chatMessage: message,
        nickname,
      };

      socket.emit('message', data);
      messageInput.value = '';
    });

    // Adiciona a mensagem a lista de mensagens enviadas, acrescenttando test id e o texto a ser exibido, e insere na arvore do DOM como elemento da UL 
    const createMessage = (chatMessage) => {
      const li = document.createElement('li');
      li.setAttribute('data-testid', 'message');
      li.innerText = chatMessage;
      listMsg.appendChild(li);
    };

    socket.on('message', (chatMessage) => createMessage(chatMessage));

    // exibe usuarios onlines e acrescenta atributos + insere como elemento filho na lista de usuarios
    socket.on('online', (users) => {
      console.log({users})
      usersList.innerHTML = '';
      chatUser = users.find((user) => user.id === socket.id)

      users = users.filter((user) => user.id !== socket.id);
      users.unshift(chatUser);
      
      users.forEach((user) => {
        const li = document.createElement('li');
        li.innerText = user.nickname;
        li.setAttribute('data-testid', 'online-user')
        usersList.appendChild(li)
      })
    })

  </script>

</html>